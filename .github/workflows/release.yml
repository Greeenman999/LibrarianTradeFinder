name: release

on:
  push:
    tags:
      - '*'

permissions:
  contents: write

env:
  MODRINTH_API_TOKEN: ${{ secrets.MODRINTH_API_TOKEN }}
  CURSEFORGE_API_TOKEN: ${{ secrets.CURSEFORGE_API_TOKEN }}
  TEST_PUBLISHING_WITH_MR_STAGING: ${{ vars.TEST_PUBLISHING_WITH_MR_STAGING }}
  ENABLE_PUBLISHING: ${{ vars.ENABLE_PUBLISHING }}

jobs:
  build:
    uses: ./.github/workflows/build_reusable.yml

  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write

    outputs:
      publish_github: ${{ steps.read-props.outputs.publish_github }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Read gradle.properties values
        id: read-props
        run: |
          VERSION=$(grep '^mod.version=' gradle.properties | cut -d'=' -f2)
          CHANNEL_TAG=$(grep '^mod.channel_tag=' gradle.properties | cut -d'=' -f2)
          PUBLISH_GITHUB=$(grep '^publish.github=' gradle.properties | cut -d'=' -f2 || echo "false")
          FULL_VERSION="${VERSION}${CHANNEL_TAG}"

          echo "mod.version=$VERSION"
          echo "mod.channel_tag=$CHANNEL_TAG"
          echo "Combined version=$FULL_VERSION"

          echo "publish_github=$PUBLISH_GITHUB" >> "$GITHUB_OUTPUT"
          echo "full_version=$FULL_VERSION" >> "$GITHUB_OUTPUT"

      - name: Validate tag matches version
        run: |
          TAG="${GITHUB_REF_NAME}"
          FULL_VERSION="${{ steps.read-props.outputs.full_version }}"

          echo "Validating tag '$TAG' against version '$FULL_VERSION'..."
          if [[ "$TAG" != "$FULL_VERSION" ]]; then
            echo "::error::Tag '$TAG' does not match version '$FULL_VERSION' in gradle.properties."
            echo "Deleting tag and release..."

            if gh release view "$TAG" &>/dev/null; then
              echo "Deleting GitHub release for $TAG..."
              gh release delete "$TAG" -y
            fi

            git push origin ":refs/tags/$TAG"
            exit 1
          fi
          echo "âœ“ Tag matches version."

  github-release:
    name: Release to GitHub
    runs-on: ubuntu-latest
    needs: prepare
    if: needs.prepare.outputs.publish_github == 'true'
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: build/libs/

      - name: Download changelog
        uses: actions/download-artifact@v4
        with:
          name: changelog
          path: .

      - name: Create or update GitHub release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${GITHUB_REF_NAME}"
          echo "Creating or updating release for $TAG"
          # Try to create the release first
          if ! gh release create "$TAG" \
            --title "$TAG" \
            --notes-file CHANGELOG-latest.md \
            --latest \
            --verify-tag \
            ./build/libs/$TAG/*; then

            echo "Release already exists. Updating existing release..."

            # Update release notes and mark as latest
            gh release edit "$TAG" \
              --title "$TAG" \
              --notes-file CHANGELOG-latest.md \
              --latest

            # Re-upload artifacts (delete first to avoid duplicates)
            for FILE in ./build/libs/$TAG/*; do
              NAME=$(basename "$FILE")
              gh release delete-asset "$TAG" "$NAME" -y || true
              gh release upload "$TAG" "$FILE" --clobber
            done
           fi


  platform-release:
    name: Release to Platforms
    runs-on: ubuntu-latest
    needs: [ prepare ]
    continue-on-error: true
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: build/libs/

      - name: Download changelog
        uses: actions/download-artifact@v4
        with:
          name: changelog
          path: .

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: 'microsoft'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: wrapper

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Publish to Platforms
        run: |
          ./gradlew publishMods --stacktrace
